import { ImageResponse } from "@vercel/og";
import { NextRequest } from "next/server";

const formatterDate = new Intl.DateTimeFormat("ja-JP", {
  year: "numeric",
  month: "long",
  day: "numeric",
});
const formatterTime = new Intl.DateTimeFormat("ja-JP", {
  hour: "numeric",
  minute: "numeric",
  hour12: true,
});

export const config = {
  runtime: "edge",
};

export default async function handler(req: NextRequest) {
  const { searchParams } = req.nextUrl;
  const message = searchParams.get("message").slice(0, 140);
  if (!message) {
    return new ImageResponse(<>{'Visit with "?message=Hello world!"'}</>, {
      width: 800,
      height: 600,
    });
  }
  const username = searchParams.get("username") || "WISS2023 参加者";
  const userid = searchParams.get("userid") || "@wiss2023";
  const date = new Date();
  const dateStr = formatterTime.format(date);
  const timeStr = formatterDate.format(date);
  const clientStr = "Pritter by Helpfeel";
  const datetimeStr = `${dateStr} · ${timeStr} · ${clientStr}`;

  return new ImageResponse(
    (
      <div
        style={{
          height: "100%",
          width: "100%",
          display: "flex",
          flexDirection: "column",
          justifyContent: "center",
          backgroundColor: "#fff",
          fontSize: 30,
          padding: "1rem 2rem",
        }}
      >
        <div
          style={{
            display: "flex",
            flexDirection: "column",
            alignItems: "flex-start",
            justifyContent: "center",
            padding: "2rem",
            border: "1px solid #ccc",
            borderRadius: "0.5rem",
          }}
        >
          <div
            style={{
              width: "100%",
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
            }}
          >
            <div
              style={{
                display: "flex",
                justifyContent: "flex-start",
                alignItems: "center",
                gap: "1rem",
              }}
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                xmlnsXlink="http://www.w3.org/1999/xlink"
                version="1.1"
                id="Layer_1"
                x="0px"
                y="0px"
                width="100%"
                viewBox="0 0 400 400"
                enable-background="new 0 0 400 400"
                xmlSpace="preserve"
                style={{ width: "4rem", height: "4rem", borderRadius: "50%" }}
              >
                <path
                  fill="#CBCBCB"
                  opacity="1.000000"
                  stroke="none"
                  d=" M70.000000,401.000000   C47.007511,401.000000 24.015022,401.000000 1.016900,401.000000   C1.011267,267.717712 1.011267,134.435440 1.011267,1.076582   C134.238693,1.076582 267.477448,1.076582 400.858093,1.076582   C400.858093,134.333221 400.858093,267.666595 400.858093,401.000000   C378.255493,401.000000 355.596405,401.000000 332.484985,400.570435   C329.939117,381.533905 324.426117,363.941650 314.934967,347.858704   C288.339844,302.792786 249.255463,278.113586 196.331955,279.385162   C155.798599,280.358978 123.224693,298.889069 98.397430,330.671814   C82.279892,351.304779 72.645370,374.803375 70.000000,401.000000  M246.866211,105.606728   C208.107346,75.088272 152.759933,89.449348 134.401505,135.121353   C125.403694,157.506042 123.187057,181.067810 126.389709,204.842010   C130.021225,231.799667 143.703506,246.437576 169.845093,251.478256   C191.271545,255.609772 212.934021,255.542664 234.366867,250.998260   C257.678345,246.055542 270.967499,231.400284 275.157135,208.041016   C277.872467,192.901611 277.017120,177.824814 274.877411,162.786087   C271.778351,141.004898 264.505157,121.127167 246.866211,105.606728  z"
                />
                <path
                  fill="#616161"
                  opacity="1.000000"
                  stroke="none"
                  d=" M70.468658,401.000000   C72.645370,374.803375 82.279892,351.304779 98.397430,330.671814   C123.224693,298.889069 155.798599,280.358978 196.331955,279.385162   C249.255463,278.113586 288.339844,302.792786 314.934967,347.858704   C324.426117,363.941650 329.939117,381.533905 332.016357,400.570435   C244.979111,401.000000 157.958206,401.000000 70.468658,401.000000  z"
                />
                <path
                  fill="#616161"
                  opacity="1.000000"
                  stroke="none"
                  d=" M247.137466,105.837738   C264.505157,121.127167 271.778351,141.004898 274.877411,162.786087   C277.017120,177.824814 277.872467,192.901611 275.157135,208.041016   C270.967499,231.400284 257.678345,246.055542 234.366867,250.998260   C212.934021,255.542664 191.271545,255.609772 169.845093,251.478256   C143.703506,246.437576 130.021225,231.799667 126.389709,204.842010   C123.187057,181.067810 125.403694,157.506042 134.401505,135.121353   C152.759933,89.449348 208.107346,75.088272 247.137466,105.837738  z"
                />
              </svg>
              <div style={{ display: "flex", flexDirection: "column" }}>
                <span style={{ fontSize: "1.5rem" }}>{username}</span>
                <span style={{ fontSize: "1.2rem", color: "gray" }}>
                  {userid}
                </span>
              </div>
            </div>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="404"
              height="346"
              viewBox="0 0 404 346"
              fill="none"
              style={{ width: "3rem", height: "3rem" }}
            >
              <g clip-path="url(#clip0_1_48)">
                <path
                  d="M170.84 112.95C160.13 112.59 137.4 111.41 130.13 111.16C128.57 111.11 126.66 110.44 126.66 108.43C126.66 106.42 128.57 105.76 130.13 105.7C137.4 105.45 160.13 104.27 170.84 103.91C186.11 103.4 188.28 95.2 196.52 92.78C196.09 78.2 194.88 56.33 191.56 40.01C186.12 13.26 179.2 0.0100098 144.92 0.0100098C110.65 0.0100098 103.72 13.26 98.2802 40.01C92.8402 66.76 93.0802 108.44 93.0802 108.44C93.0802 108.44 92.8402 150.11 98.2802 176.87C103.72 203.62 110.64 216.87 144.92 216.87C179.19 216.87 186.12 203.62 191.56 176.87C194.88 160.54 196.09 138.68 196.52 124.1C188.28 121.66 186.11 113.46 170.84 112.95Z"
                  fill="black"
                />
                <path
                  d="M304.73 40C299.29 13.25 292.37 0 258.09 0C223.82 0 216.89 13.25 211.45 40C208.13 56.34 206.92 78.23 206.49 92.81C214.63 95.28 216.86 103.39 232.05 103.9C242.76 104.26 265.49 105.44 272.76 105.69C274.32 105.74 276.23 106.41 276.23 108.42C276.23 110.43 274.32 111.09 272.76 111.15C265.49 111.4 242.76 112.58 232.05 112.94C216.86 113.45 214.63 121.57 206.49 124.03C206.92 138.61 208.13 160.5 211.45 176.84C216.89 203.59 223.81 216.84 258.09 216.84C292.36 216.84 299.29 203.59 304.73 176.84C310.17 150.09 309.93 108.41 309.93 108.41C309.93 108.41 310.17 66.75 304.73 40Z"
                  fill="black"
                />
                <path
                  d="M146.35 256.21H132.54V329.79H146.35V256.21Z"
                  fill="black"
                />
                <path
                  d="M44.76 256.21V287.52H13.81V256.21H0V329.79H13.81V298.49H44.76V329.79H58.57V256.21H44.76Z"
                  fill="black"
                />
                <path
                  d="M190.62 274.48C183.25 275.15 176.49 278.93 172.39 285.87L172.4 275.43H158.59L158.52 345.85H172.33L172.36 318.86C176.46 325.83 183.24 329.63 190.63 330.3C203.47 331.46 217.21 322.09 217.21 302.39C217.2 282.69 203.46 273.32 190.62 274.48ZM189.25 318.45C182.39 317.83 176.16 311.8 176.16 302.39C176.16 292.99 182.39 286.96 189.25 286.33C196.63 285.66 204.54 291.05 204.54 302.39C204.54 313.72 196.64 319.12 189.25 318.45Z"
                  fill="black"
                />
                <path
                  d="M121.45 307.51C123.57 288.5 114.55 274.39 95.5598 274.39C77.6098 274.39 69.3398 286.93 69.3398 302.4C69.3398 317.87 77.5998 330.41 95.5598 330.41C108.63 330.41 116.56 323.76 119.91 314.17H105.74C103.47 316.91 100.11 318.6 95.5598 318.6C87.9998 318.6 83.7098 313.95 82.2898 307.51H121.45ZM82.2598 297.41C83.6498 290.9 87.9398 286.19 95.5598 286.19C103.17 286.19 107.47 290.9 108.86 297.41H82.2598Z"
                  fill="black"
                />
                <path
                  d="M403.02 256.21H389.21V329.79H403.02V256.21Z"
                  fill="black"
                />
                <path
                  d="M378.13 307.51C380.25 288.5 371.23 274.39 352.24 274.39C334.29 274.39 326.02 286.93 326.02 302.4C326.02 317.87 334.28 330.41 352.24 330.41C365.31 330.41 373.24 323.76 376.59 314.17H362.42C360.15 316.91 356.79 318.6 352.24 318.6C344.68 318.6 340.39 313.95 338.97 307.51H378.13ZM338.93 297.41C340.32 290.9 344.61 286.19 352.23 286.19C359.84 286.19 364.14 290.9 365.53 297.41H338.93Z"
                  fill="black"
                />
                <path
                  d="M317.14 307.51C319.26 288.5 310.24 274.39 291.25 274.39C273.3 274.39 265.03 286.93 265.03 302.4C265.03 317.87 273.29 330.41 291.25 330.41C304.32 330.41 312.25 323.76 315.6 314.17H301.43C299.16 316.91 295.8 318.6 291.25 318.6C283.69 318.6 279.4 313.95 277.98 307.51H317.14ZM277.95 297.41C279.34 290.9 283.63 286.19 291.25 286.19C298.86 286.19 303.16 290.9 304.55 297.41H277.95Z"
                  fill="black"
                />
                <path
                  d="M258.45 268.36V256.06C243.92 253.41 230.42 260.99 230.93 280.02H223.65V290.12H230.93C230.93 305.65 230.93 329.7 230.93 329.7H244.72C244.72 329.7 244.72 305.07 244.72 290.12H258.44V280.02H244.72C244.27 268.35 253.23 267.08 258.45 268.36Z"
                  fill="black"
                />
              </g>
              <defs>
                <clipPath id="clip0_1_48">
                  <rect width="403.02" height="345.85" fill="white" />
                </clipPath>
              </defs>
            </svg>
          </div>
          <div style={{ padding: "2rem 0", fontSize: "2rem" }}>{message}</div>
          <div
            style={{
              display: "flex",
              flexDirection: "row",
              fontSize: "1rem",
              color: "gray",
              gap: "0.2rem",
            }}
          >
            <span>{datetimeStr}</span>
          </div>
        </div>
      </div>
    ),
    {
      width: 800,
      height: 600,
    }
  );
}
